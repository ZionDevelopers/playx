<html>
<head>

<!--Setup layout and black background to avoid floating video on white-->
<style type="text/css">
	body {
  margin: 0;
  padding: 0;
  border: 0;
  background: #000000;
  overflow: hidden;
  }
</style>

<title>PlayX Native Youtube Host</title>
	<script>
	function inject () {

  		// return a custom MIME type checker that can defer to the original function
  		function makeModifiedTypeChecker(origChecker) {
    		// Check if a video type is allowed
    		return function (type) {
     			if (type === undefined) return '';
      			var disallowed_types = ['webm', 'vp8', 'vp9', 'mp4', 'video/mp4', 'avc1'];
      			// If video type is in disallowed_types, say we don't support them
      			for (var i = 0; i < disallowed_types.length; i++) {
        			if (type.indexOf(disallowed_types[i]) !== -1) return '';
      			}

      			// Otherwise, ask the browser
      			return origChecker(type);
    		};
  }

  // Override video element canPlayType() function
  var videoElem = document.createElement('video');
  var origCanPlayType = videoElem.canPlayType.bind(videoElem);
  console.log("origCanPlayType: " + origCanPlayType);
  videoElem.__proto__.canPlayType = makeModifiedTypeChecker(origCanPlayType);

  // Override media source extension isTypeSupported() function
  var mse = window.MediaSource;
  // Check for MSE support before use
  if (mse === undefined) return;
  var origIsTypeSupported = mse.isTypeSupported.bind(mse);
  mse.isTypeSupported = makeModifiedTypeChecker(origIsTypeSupported);
}
		
	var injectScript = document.createElement('script');
		// Use textContent instead of src to run inject() synchronously
		injectScript.textContent = inject.toString() + "inject();";
		console.log(injectScript.textContent.toString());
		injectScript.onload = function() {
 			// Remove <script> node after injectScript runs.
 			this.parentNode.removeChild(this);
		};
	(document.head || document.documentElement).appendChild(injectScript);
	</script>
	
<script src="https://www.youtube.com/iframe_api"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/swfobject/2.2/swfobject.js" type="text/javascript"></script>
<script src="/playx/js/flash_detect_min.js"></script>
	
<script>
	
	//------------------------------------------------- GET FROM URL FUNCS -------------------------------------------------//
	
//Get a var from url format
function get(variable)
{
       var query = window.location.search.substring(1);
       var vars = query.split("&");
       for (var i=0;i<vars.length;i++) {
               var pair = vars[i].split("=");
               if(pair[0] == variable){return pair[1];}
       }
       return(false);
}
//Separates variable from identifier, returns value of var
function getByURL(variable, query)
{
       var vars = query.split("?");
       for (var i=0;i<vars.length;i++) {
               var pair = vars[i].split("=");
               if(pair[0] == variable){return pair[1];}
       }
       return(false);
}
//Look At URL For Params
var urlParam = function(name, w){
    w = w || window;
    var rx = new RegExp('[\&|\?]'+name+'=([^\&\#]+)'),
        val = w.location.search.match(rx);
    return !val ? '':val[1];
}

	//------------------------------------------------- END GET FROM URL FUNCS -------------------------------------------------//


	//------------------------------------------------- START AT CODE -------------------------------------------------//
/*
//Convert youtube #h#m#s time into seconds
//&start= or &t= can be either in pure seconds or in any order of hours, minutes, seconds in the format of #h#m#s.
//Ex: 2h41m12s = 2 hours, 41 minutes, and 12 seconds
function youtubeTimeConvert(duration){
	var total = 0;
	var hours = duration.match(/(\d+)[hH]/);
	var minutes = duration.match(/(\d+)[mM]/);
	var seconds = duration.match(/(\d+)[sS]/);
	if (hours) total += parseInt(hours[1]) * 3600;
	if (minutes) total += parseInt(minutes[1]) * 60;
	if (seconds) total += parseInt(seconds[1]);
	return total;
}
// Start Time Assignment (Universal)
if (start === "" || start === undefined){ //if start is empty, look at t
	if (t != "" && t === undefined) {
		if (/^\d+$/.test(t)){ //if no characters found, t is in seconds
			var startoutput = t;
			console.log("Time t= is pure")
		} else { //if characters found, decode from youtube time format
			var startoutput = youtubeTimeConvert(t);
			console.log("Time t= is in #h#m#s format");
		}
	} else { //if start and t are empty, start at 0
		var startoutput = 0
	}
} else {
	if ((start) && ((/^\d+$/.test(start)) == true)) { //if start is occupied and has only numbers, start is in seconds
		var startoutput = start
	} else if(start != "" && start != undefined) { //else, start is in youtube time format, convert to seconds
		var startoutput = youtubeTimeConvert(start);
	}
}
*/
var startoutput = 0;
	
	//------------------------------------------------- END START AT CODE -------------------------------------------------//
	
	
	//-------------------------------------------- VARIABLE DECLARATION AND PLAYERS --------------------------------------------//
	
	//Define Our Vars For Our Players
	var url = urlParam('url');
	var start = urlParam('start');
	var t = urlParam('t');
	var internalstart = start;
	
	var videoId = get('v') || getByURL('v', urlParam('url'));
	
	var playerType;

	//-------------------------------------------- END VARIABLE DECLARATION AND PLAYERS --------------------------------------------//

	//------------------------------------------------- FLASH DETECTION -------------------------------------------------//
	
	//If flash is installed, use flash instead of the standard youtube embed
	//This fixes the random issues with Awesomium and the YT Player
	//This will be removed once CEF is live.
	if (FlashDetect.installed) {
		var flashVer = FlashDetect.raw;
		console.log("Flash Is Installed, Checking Build");
	} else {
			flashVer = null
		console.log("Flash Is Not Installed");
	}
	console.log("Raw Build: " + flashVer);

	if (FlashDetect.installed) {
		console.log("Playing in Flash");
	}
	
	//------------------------------------------------- END FLASH DETECTION -------------------------------------------------//

	//------------------------------------------------- CHOOSE PLAYER AND PLAY VIDEO -------------------------------------------------//

function onYouTubeIframeAPIReady() {
//if (FlashDetect.installed) {
//	YouTubeFlashPlayer(videoId, startoutput);
//	playerType = "Flash";
//} else {
	YouTubeIFramePlayer(videoId, startoutput);
	playerType = "HTML5";
//}
}
	
//YouTube Flash Player (yva_video)(Have to use Flash since Awesomium hates HTML5)
var YouTubeFlashPlayer = function(videoId, startoutput){
			
	//Define Player Params and Attributes (SWFObject Embed for yva_video)
	var srcparams = {
		allowScriptAccess: "always",
		bgcolor: "#000000",
		wmode: "opaque"
	};
			
	var srcattributes = {
		id: "player",
	};
			
	//Set YouTube Flash Player Source URL (yva_video 
	var srcurl = 'https://youtube.googleapis.com/yva_video?enablejsapi=1&amp;autoplay=1&amp;fs=1&amp;hl=en';
	srcurl += '&amp;modestbranding=1&amp;autohide=1&amp;showinfo=0&amp;controls=0&amp;iv_load_policy=3&amp;vq=hd720';
	srcurl += '&amp;docid=' + videoId + '&amp;start=' + startoutput;
	srcurl += '&amp;oref=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3D' + videoId + '&amp;has_verified=1';
	swfobject.embedSWF(srcurl, "player", "100.0%", "100.0%", "9", null, null, srcparams, srcattributes);
			
	//Set Player Params (called by our onReady detection callback defined above)
	this.onReady = function() {
		console.log("YT Flash Player onReady() Called");
		//this.player = document.getElementById('player');
		//this.player = document.getElementById('player');
		this.player.style.width = "126.6%";
		this.player.style.height = "104.2%";
		this.player.style.marginLeft = "-24.2%";
		this.player.style.marginTop = "-2%";
	}
}

//YouTube IFrame Player (Fallback until CEF)
var YouTubeIFramePlayer = function(videoId, startoutput){
	
	//YouTube Embed Code
	console.log("Playing in HTML5");
	
	player = new YT.Player('player', {
    		"width": window.innerWidth, //set size to full window or bounds of PlayX screen
		"height": window.innerHeight, //set size to full window or bounds of PlayX screen
    		videoId: videoId, //get uri from ?url=, either from ?v= or pure uri
   		playerVars: {
			autoplay: 1,
			showinfo: 0, //Disable title / creator label
			cc_load_policy: 1, //Remedies issues with some captions randomly coming up
			iv_load_policy: 3, //Removes all annotations
			disablekb: 1, //Disables keybaord to avoid accidental pausing / seeking of video
			modestbranding: 1, //Remove YouTube logo
			rel: 0, //Disable end video recommendations
			controls: 0, //Disable player UI controls
			start: start || 0, //YT Start: Requires for this value to be in string format for some reason
    		},
		events: {
			onReady: onYouTubePlayerReady,
		}
  	});
	
	this.onReady = function(){
		console.log("HTML5 Player onReady() Called");
		this.player.style.width = window.innerWidth;
		this.player.style.height = window.innerHeight;
		this.player.style.marginLeft = "0";
		this.player.style.marginTop = "0";
	}
	
}
	
//------------------------------------------------- GLOBAL PLAYER FUNCTIONS -------------------------------------------------//
	
	function onYouTubePlayerReady( playerId ) {
		var player = document.getElementById('player');
		console.log("onYouTubePlayerReady() Global Called");
		onReady();
		player.addEventListener("onError", "onYouTubePlayerError");
	}
	
	function onYouTubePlayerError(e) {
		console.log("Youtube Threw An Error :/");
		if (e>=101) {
			console.log("Switching To IFrame API");
			playerType = "HTML5";
			YouTubeIFramePlayer(videoId, startoutput);
		}
	}
	
//------------------------------------------------- ANALYTICS -------------------------------------------------//
	
  //Google Analytics
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	
  ga('create', 'UA-92533032-1', 'auto'); //Science Tracker
  ga('create', 'UA-43230779-1', 'ziondevelopers.github.io'); //Dathus Tracker
  ga('send', 'pageview');
  ga('ziondevelopers.github.io', 'pageview');
	
</script>
</head>

  <body>
    <div id="player"></div> 
  </body>
</html>
