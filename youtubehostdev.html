<html>
<head>

<!--Setup layout and black background to avoid floating video on white-->
<style type="text/css">
	body {
  margin: 0;
  padding: 0;
  border: 0;
  background: #000000;
  overflow: hidden;
  }
</style>

<title>PlayX Native Youtube Host</title>
<script src="https://www.youtube.com/iframe_api"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/swfobject/2.2/swfobject.js" type="text/javascript"></script>
<script src="/playx/js/flash_detect_min.js"></script>

<script>
//Get a var from url format
function get(variable)
{
       var query = window.location.search.substring(1);
       var vars = query.split("&");
       for (var i=0;i<vars.length;i++) {
               var pair = vars[i].split("=");
               if(pair[0] == variable){return pair[1];}
       }
       return(false);
}
//Separates variable from identifier, returns value of var
function getByURL(variable, query)
{
       var vars = query.split("?");
       for (var i=0;i<vars.length;i++) {
               var pair = vars[i].split("=");
               if(pair[0] == variable){return pair[1];}
       }
       return(false);
}
//Look At URL For Params
var urlParam = function(name, w){
    w = w || window;
    var rx = new RegExp('[\&|\?]'+name+'=([^\&\#]+)'),
        val = w.location.search.match(rx);
    return !val ? '':val[1];
}

//Convert youtube #h#m#s time into seconds
//&start= or &t= can be either in pure seconds or in any order of hours, minutes, seconds in the format of #h#m#s.
//Ex: 2h41m12s = 2 hours, 41 minutes, and 12 seconds
function youtubeTimeConvert(duration){
	var total = 0;
	var hours = duration.match(/(\d+)[hH]/);
	var minutes = duration.match(/(\d+)[mM]/);
	var seconds = duration.match(/(\d+)[sS]/);
	if (hours) total += parseInt(hours[1]) * 3600;
	if (minutes) total += parseInt(minutes[1]) * 60;
	if (seconds) total += parseInt(seconds[1]);
	return total;
}
	
	//OLD Params
	//var url = unescape(get("url"));
	//var start = unescape(get("start"));
	//Insert Params Into Vars
	var url = urlParam('url');
	var start = urlParam('start');
	var t = urlParam('t');
	var internalstart = start;
	
	var videoId = get('v') || getByURL('v', urlParam('url'))
	
	// Start Time Assignment (Universal)
	if (start === ""){ //if start is empty, look at t
		if (t != "") {
			if (/^\d+$/.test(t)){ //if no characters found, t is in seconds
			    var startoutput = t;
			    console.log("Time t= is pure")
			} else { //if characters found, decode from youtube time format
			    var startoutput = youtubeTimeConvert(t);
			    console.log("Time t= is in #h#m#s format");
			}
		} else { //if start and t are empty, start at 0
			var startoutput = 0
		}
	} else {
		if ((start != "") && ((/^\d+$/.test(start)) == true)) { //if start is occupied and has only numbers, start is in seconds
			var startoutput = start
		} else { //else, start is in youtube time format, convert to seconds
			var startoutput = youtubeTimeConvert(start);
		}
	}
	
	//If flash is installed, use flash instead of the standard youtube embed
	//This fixes the random issues with Awesomium and the YT Player
	//This will be removed once CEF is live.
	if (FlashDetect.installed) {
	var flashVer = FlashDetect.raw;
	} else {
		flashVer = null
	}
	console.log(flashVer);
	//console.log(flashVer.includes("VLC"));
	
	function onYouTubeIframeAPIReady() {
		console.log("IFrameAPIReady");
		if (FlashDetect.installed) {
			console.log("Playing in Flash");
			
			//Since yva_video has no onReady function, we need to make our own with SWFObject (to prevent weird bugs from
			//thing loading too soon before the SWF is ready
			function swfLoadEvent(fn){
    				//Ensure fn is a valid function
    				if(typeof fn !== "function"){ return false; }
   				//This timeout ensures we don't try to access PercentLoaded too soon
    				var initialTimeout = setTimeout(function (){
        				//Ensure Flash Player's PercentLoaded method is available and returns a value
        				if(typeof e.ref.PercentLoaded !== "undefined" && e.ref.PercentLoaded()){
            					//Set up a timer to periodically check value of PercentLoaded
            					var loadCheckInterval = setInterval(function (){
                					//Once value == 100 (fully loaded) we can do whatever we want
                					if(e.ref.PercentLoaded() === 100){
                    						//Execute function
								console.log(e.ref.PercentLoaded().toString());
                    						fn();
                    						//Clear timer
                    						clearInterval(loadCheckInterval);
                					}
            					}, 1500);
        				}
    				}, 200);
			}
			
			//This function is invoked by SWFObject once the <object> has been created
			var callback = function (e){
    				//Only execute if SWFObject embed was successful
    				if(!e.success || !e.ref){ return false; }
    				swfLoadEvent(onReady());
			};
			
			var srcparams = {
				allowScriptAccess: "always",
				bgcolor: "#000000",
				wmode: "opaque"
			};
			
			var srcattributes = {
				id: "player",
			};
			
			//Set YouTube Flash Player Source URL (yva_video in this case)
			var srcurl = 'https://youtube.googleapis.com/yva_video?enablejsapi=1&amp;autoplay=1&amp;fs=1&amp;hl=en';
			srcurl += '&amp;modestbranding=1&amp;autohide=1&amp;showinfo=0&amp;controls=0&amp;iv_load_policy=3&amp;vq=hd720';
			srcurl += '&amp;docid=' + videoId + '&amp;start=' + startoutput;
			swfobject.embedSWF(srcurl, "player", "100.0%", "100.0%", "9", null, null, srcparams, srcattributes, callback);
			
			//Set Player Params (Because of Weird yva_video scaling)(also wait for iframe to load, acts weird sometimes without delay)
			function onReady() {
				console.log("onYouTubePlayerReady Called");
				ytplayer = document.getElementById('player');
				ytplayer.style.width = "126.6%";
				ytplayer.style.height = "104.2%";
				ytplayer.style.marginLeft = "-24.2%";
				ytplayer.style.marginTop = "-2%";
				
			}
		//If there is no Flash available, fall back to HTML5 (Majorly glitchy with Awesomium)
		} else {
		
		//YouTube Embed Code
		console.log("Playing in HTML5");
		console.log("YouTube API Fired, loading Player");
    		player = new YT.Player('player', {
        		"width": window.innerWidth, //set size to full window or bounds of PlayX screen
			"height": window.innerHeight, //set size to full window or bounds of PlayX screen
        		videoId: videoId, //get uri from ?url=, either from ?v= or pure uri
        		playerVars: {
				autoplay: 1,
				showinfo: 0, //Disable title / creator label
				cc_load_policy: 1, //Remedies issues with some captions randomly coming up
				iv_load_policy: 3, //Removes all annotations
				disablekb: 1, //Disables keybaord to avoid accidental pausing / seeking of video
				modestbranding: 1, //Remove YouTube logo
				rel: 0, //Disable end video recommendations
				controls: 0, //Disable player UI controls
				start: start || 0, //YT Start: Requires for this value to be in string format for some reason
        		},
    		});
		}
	}

	
  //Google Analytics
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	
  ga('create', 'UA-92533032-1', 'auto'); //Science Tracker
  ga('create', 'UA-43230779-1', 'ziondevelopers.github.io'); //Dathus Tracker
  ga('send', 'pageview');
  ga('ziondevelopers.github.io', 'pageview');
	
</script>
</head>

  <body>
    <div id="player"></div> 
  </body>
</html>
